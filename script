// ===========================================
// script.js - R.E.S.C.A.T.E. Plan de Estudios
// ===========================================
// Versi√≥n optimizada para GitHub Pages
// Compatible con HTML y CSS proporcionados

// CONFIGURACI√ìN INICIAL
const CONFIG = {
    appName: 'R.E.S.C.A.T.E. Paramedico',
    version: '1.0.0',
    storageKey: 'rescate_paramedico_ghpages',
    defaultTheme: 'light',
    features: {
        flashcards: true,
        quizzes: true,
        progressTracking: true,
        darkMode: true
    }
};

// DATOS DEL PLAN DE ESTUDIOS (completos)
const PLAN_ESTUDIOS = {
    modulos: [
        {
            id: 1,
            titulo: "PROPED√âUTICO (PRIMEROS AUXILIOS B√ÅSICOS E INTERMEDIOS)",
            temas: [
                "Primeros auxilios b√°sicos",
                "Primeros auxilios intermedios",
                "Introducci√≥n al sistema m√©dico de urgencias"
            ],
            horas: 40,
            icono: "fa-stethoscope"
        },
        {
            id: 2,
            titulo: "EL CUERPO HUMANO (PRINCIPIOS DE ANATOM√çA Y FISIOLOG√çA)",
            temas: [
                "Anatom√≠a y fisiolog√≠a esencial",
                "Anatom√≠a y fisiolog√≠a intermedia",
                "Anatom√≠a opcional"
            ],
            horas: 50,
            icono: "fa-heart-pulse"
        },
        {
            id: 3,
            titulo: "EVALUACI√ìN INICIAL Y SOPORTE VITAL",
            temas: [
                "Evaluaci√≥n primaria",
                "Evaluaci√≥n secundaria",
                "Manejo de la v√≠a a√©rea",
                "V√≠a intravenosa",
                "Monitor desfibrilador"
            ],
            horas: 60,
            icono: "fa-heart-circle-plus"
        },
        {
            id: 4,
            titulo: "MANEJO DE URGENCIAS M√âDICO QUIR√öRGICAS",
            temas: [
                "Epidemiolog√≠a y clasificaci√≥n de enfermedades",
                "Farmacolog√≠a",
                "Pr√°cticas",
                "Urgencias respiratorias",
                "Urgencias gastrointestinales",
                "Urgencias cardiol√≥gicas",
                "Urgencias metab√≥licas",
                "Urgencias urinarias",
                "Urgencias del sistema nervioso",
                "Urgencias gineco-obst√©tricas",
                "Urgencias toxicol√≥gicas"
            ],
            horas: 80,
            icono: "fa-briefcase-medical"
        },
        {
            id: 5,
            titulo: "EMERGENCIAS TRAUMATOL√ìGICAS",
            temas: [
                "Cinem√°tica de trauma y mecanismos de lesi√≥n",
                "Hemorragia y estado de shock",
                "Trauma de t√≥rax",
                "Trauma de abdomen",
                "Trauma de cr√°neo y columna",
                "Trauma de ojo, cara y cuello",
                "Trauma musculoesquel√©tico",
                "Lesiones ambientales",
                "Quemaduras"
            ],
            horas: 70,
            icono: "fa-user-injured",
            certificacion: "CERTIFICADO RED CONOCER (SEP)"
        },
        {
            id: 6,
            titulo: "POBLACIONES ESPECIALES (URGENCIAS PEDI√ÅTRICAS Y GERI√ÅTRICAS)",
            temas: [
                "Introducci√≥n a la pediatr√≠a y evaluaci√≥n del paciente pedi√°trico",
                "Situaciones especiales",
                "Soporte vital en pedi√°trico",
                "Emergencias m√©dico quir√∫rgicas en pediatr√≠a",
                "Traumatismo en el paciente pedi√°trico",
                "Introducci√≥n a la geriatr√≠a",
                "Evaluaci√≥n y manejo del paciente geri√°trico"
            ],
            horas: 55,
            icono: "fa-children"
        },
        {
            id: 7,
            titulo: "OPERACIONES ESPECIALES",
            temas: [
                "Operaciones de ambulancias",
                "Obtenci√≥n de acceso y extracci√≥n",
                "Operaciones especiales",
                "Manejo de escenarios con m√∫ltiples v√≠ctimas (Triage)",
                "Campamento y supervivencia"
            ],
            horas: 45,
            icono: "fa-truck-medical"
        }
    ],
    requisitos: {
        servicioSocial: 320,
        cursosEspecializacion: 2,
        campamento: 1
    }
};

// DATOS DE FLASHCARDS (completos para GitHub Pages)
const FLASHCARDS_DATA = {
    1: [
        {
            id: 1,
            pregunta: "¬øCu√°l es el primer paso en la evaluaci√≥n de un paciente?",
            respuesta: "Evaluaci√≥n primaria: verificar consciencia, v√≠a a√©rea, respiraci√≥n y circulaci√≥n (ABC).",
            categoria: "Evaluaci√≥n",
            dificultad: "b√°sica"
        },
        {
            id: 2,
            pregunta: "¬øQu√© es el triage y cu√°l es su prop√≥sito?",
            respuesta: "El triage es el proceso de clasificaci√≥n de pacientes seg√∫n la gravedad de sus lesiones para priorizar la atenci√≥n en situaciones con m√∫ltiples v√≠ctimas.",
            categoria: "Terminolog√≠a",
            dificultad: "intermedia"
        },
        {
            id: 3,
            pregunta: "¬øCu√°les son los signos de una v√≠a a√©rea obstruida?",
            respuesta: "Sonidos respiratorios anormales (estridor, estertores), uso de m√∫sculos accesorios, cianosis, agitaci√≥n o disminuci√≥n del nivel de consciencia.",
            categoria: "S√≠ntomas",
            dificultad: "b√°sica"
        },
        {
            id: 4,
            pregunta: "¬øQu√© es el shock y cu√°les son sus tipos principales?",
            respuesta: "El shock es un estado de perfusi√≥n tisular inadecuada. Los tipos principales son: hipovol√©mico, cardiog√©nico, distributivo y obstructivo.",
            categoria: "Fisiopatolog√≠a",
            dificultad: "avanzada"
        },
        {
            id: 5,
            pregunta: "¬øC√≥mo se realiza la maniobra de Heimlich en adultos?",
            respuesta: "Colocarse detr√°s del paciente, rodearlo con los brazos, hacer un pu√±o con una mano y colocar el pulgar por encima del ombligo, agarrar el pu√±o con la otra mano y realizar compresiones abdominales hacia arriba y adentro.",
            categoria: "T√©cnicas",
            dificultad: "b√°sica"
        }
    ],
    2: [
        {
            id: 1,
            pregunta: "¬øCu√°les son los huesos del cr√°neo?",
            respuesta: "Frontal, parietal (2), temporal (2), occipital, esfenoides y etmoides.",
            categoria: "Anatom√≠a",
            dificultad: "b√°sica"
        },
        {
            id: 2,
            pregunta: "¬øQu√© es el sistema cardiovascular y qu√© √≥rganos lo componen?",
            respuesta: "El sistema cardiovascular est√° formado por el coraz√≥n, vasos sangu√≠neos (arterias, venas, capilares) y la sangre. Su funci√≥n es transportar ox√≠geno, nutrientes y hormonas a las c√©lulas.",
            categoria: "Fisiolog√≠a",
            dificultad: "intermedia"
        }
    ],
    3: [
        {
            id: 1,
            pregunta: "¬øCu√°l es la secuencia ABCDE en la evaluaci√≥n primaria?",
            respuesta: "A: V√≠a a√©rea, B: Respiraci√≥n, C: Circulaci√≥n, D: Discapacidad neurol√≥gica, E: Exposici√≥n/Control ambiental.",
            categoria: "Protocolos",
            dificultad: "b√°sica"
        },
        {
            id: 2,
            pregunta: "¬øCu√°l es la frecuencia de compresiones tor√°cicas en RCP para adultos?",
            respuesta: "100-120 compresiones por minuto, con una profundidad de 5-6 cm.",
            categoria: "RCP",
            dificultad: "b√°sica"
        }
    ],
    4: [
        {
            id: 1,
            pregunta: "¬øCu√°les son los signos de un infarto agudo de miocardio?",
            respuesta: "Dolor tor√°cico opresivo, irradiado a brazo izquierdo, mand√≠bula o espalda; diaforesis, n√°useas, disnea y sensaci√≥n de muerte inminente.",
            categoria: "Cardiolog√≠a",
            dificultad: "intermedia"
        }
    ],
    5: [
        {
            id: 1,
            pregunta: "¬øQu√© es el trauma penetrante vs. trauma contuso?",
            respuesta: "Penetrante: lesi√≥n por objeto que perfora la piel y tejidos. Contuso: lesi√≥n por impacto sin penetraci√≥n de la piel.",
            categoria: "Trauma",
            dificultad: "b√°sica"
        }
    ],
    6: [
        {
            id: 1,
            pregunta: "¬øCu√°l es la frecuencia cardiaca normal en un lactante?",
            respuesta: "100-160 latidos por minuto.",
            categoria: "Pediatr√≠a",
            dificultad: "b√°sica"
        }
    ],
    7: [
        {
            id: 1,
            pregunta: "¬øQu√© es el triage START y cu√°les son sus categor√≠as?",
            respuesta: "Sistema Simple de Triage y Tratamiento R√°pido. Categor√≠as: Rojo (inmediato), Amarillo (urgente), Verde (m√≠nimo), Negro (fallecido/expectante).",
            categoria: "Operaciones",
            dificultad: "intermedia"
        }
    ]
};

// DATOS DE QUIZZES (completos para GitHub Pages)
const QUIZZES_DATA = {
    1: {
        titulo: "Quiz - M√≥dulo 1: Proped√©utico",
        preguntas: [
            {
                id: 1,
                pregunta: "¬øCu√°l es la frecuencia de compresiones tor√°cicas en RCP para adultos?",
                opciones: [
                    "60-80 compresiones por minuto",
                    "100-120 compresiones por minuto",
                    "80-100 compresiones por minuto",
                    "120-140 compresiones por minuto"
                ],
                respuestaCorrecta: 1,
                explicacion: "La AHA recomienda 100-120 compresiones por minuto para RCP en adultos.",
                puntos: 10
            },
            {
                id: 2,
                pregunta: "¬øCu√°l es la relaci√≥n compresiones:ventilaciones en RCP para adultos con un solo reanimador?",
                opciones: [
                    "15:2",
                    "30:2",
                    "5:1",
                    "10:1"
                ],
                respuestaCorrecta: 1,
                explicacion: "Para un solo reanimador en adultos, la relaci√≥n es 30 compresiones por 2 ventilaciones.",
                puntos: 10
            },
            {
                id: 3,
                pregunta: "¬øQu√© signo NO es parte de la evaluaci√≥n primaria (ABCDE)?",
                opciones: [
                    "V√≠a a√©rea (Airway)",
                    "Exposici√≥n (Exposure)",
                    "Temperatura (Temperature)",
                    "Circulaci√≥n (Circulation)"
                ],
                respuestaCorrecta: 2,
                explicacion: "ABCDE significa: Airway, Breathing, Circulation, Disability, Exposure. Temperatura no es parte de esta evaluaci√≥n inicial.",
                puntos: 10
            }
        ]
    },
    2: {
        titulo: "Quiz - M√≥dulo 2: Anatom√≠a y Fisiolog√≠a",
        preguntas: [
            {
                id: 1,
                pregunta: "¬øCu√°l es el hueso m√°s largo del cuerpo humano?",
                opciones: [
                    "F√©mur",
                    "Tibia",
                    "H√∫mero",
                    "Peron√©"
                ],
                respuestaCorrecta: 0,
                explicacion: "El f√©mur es el hueso m√°s largo y fuerte del cuerpo humano.",
                puntos: 10
            },
            {
                id: 2,
                pregunta: "¬øQu√© √≥rgano produce la bilis?",
                opciones: [
                    "P√°ncreas",
                    "H√≠gado",
                    "Ves√≠cula biliar",
                    "Est√≥mago"
                ],
                respuestaCorrecta: 1,
                explicacion: "El h√≠gado produce bilis, que se almacena en la ves√≠cula biliar y se libera para digerir grasas.",
                puntos: 10
            }
        ]
    },
    3: {
        titulo: "Quiz - M√≥dulo 3: Soporte Vital",
        preguntas: [
            {
                id: 1,
                pregunta: "¬øCu√°l es la profundidad adecuada de compresiones tor√°cicas en adultos?",
                opciones: [
                    "2-3 cm",
                    "3-4 cm",
                    "5-6 cm",
                    "7-8 cm"
                ],
                respuestaCorrecta: 2,
                explicacion: "Las compresiones deben tener una profundidad de al menos 5 cm pero no m√°s de 6 cm en adultos.",
                puntos: 10
            }
        ]
    }
};

// ESTADO DE LA APLICACI√ìN
let APP_STATE = {
    tema: CONFIG.defaultTheme,
    progreso: {
        modulosCompletados: [],
        flashcardsEstudiadas: 0,
        quizzesCompletados: [],
        horasServicio: 0,
        ultimoAcceso: null
    },
    sesion: {
        moduloActual: 1,
        flashcardActual: {
            modulo: 1,
            indice: 0,
            volteada: false
        },
        quizActual: {
            modulo: 1,
            indicePregunta: 0,
            respuestas: [],
            completado: false,
            puntaje: 0
        }
    }
};

// ===========================================
// INICIALIZACI√ìN PRINCIPAL
// ===========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log(`${CONFIG.appName} v${CONFIG.version} - GitHub Pages`);
    
    // Cargar estado guardado
    cargarEstado();
    
    // Inicializar componentes
    inicializarTema();
    inicializarNavegacion();
    inicializarModulos();
    inicializarFlashcards();
    inicializarQuizzes();
    inicializarRecursos();
    inicializarProgreso();
    inicializarEventosGlobales();
    
    // Mostrar informaci√≥n de GitHub Pages
    if (window.location.hostname.includes('github.io')) {
        console.log('‚úÖ Ejecutando en GitHub Pages');
        mostrarNotificacion('GitHub Pages activo - Tu progreso se guarda localmente', 'info', 3000);
    }
    
    // Registrar acceso
    APP_STATE.progreso.ultimoAcceso = new Date().toISOString();
    guardarEstado();
    
    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
});

// ===========================================
// GESTI√ìN DEL TEMA (CLARO/OSCURO)
// ===========================================
function inicializarTema() {
    // Cargar tema guardado o usar default
    APP_STATE.tema = localStorage.getItem('rescate_tema') || CONFIG.defaultTheme;
    
    // Aplicar tema
    aplicarTema(APP_STATE.tema);
    
    // Configurar bot√≥n de cambio
    const botonTema = document.getElementById('theme-toggle');
    if (botonTema) {
        botonTema.addEventListener('click', alternarTema);
        actualizarIconoTema();
    }
}

function aplicarTema(tema) {
    const body = document.body;
    const html = document.documentElement;
    
    if (tema === 'dark') {
        body.classList.add('dark-theme');
        html.setAttribute('data-theme', 'dark');
    } else {
        body.classList.remove('dark-theme');
        html.setAttribute('data-theme', 'light');
    }
    
    APP_STATE.tema = tema;
    localStorage.setItem('rescate_tema', tema);
}

function alternarTema() {
    APP_STATE.tema = APP_STATE.tema === 'light' ? 'dark' : 'light';
    aplicarTema(APP_STATE.tema);
    actualizarIconoTema();
    mostrarNotificacion(`Modo ${APP_STATE.tema === 'light' ? 'claro' : 'oscuro'} activado`, 'info');
}

function actualizarIconoTema() {
    const icono = document.querySelector('#theme-toggle i');
    if (icono) {
        icono.className = APP_STATE.tema === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }
}

// ===========================================
// NAVEGACI√ìN Y MEN√ö
// ===========================================
function inicializarNavegacion() {
    // Men√∫ hamburguesa para m√≥viles
    const botonMenu = document.querySelector('.nav-toggle');
    const menu = document.querySelector('.nav-menu');
    
    if (botonMenu && menu) {
        botonMenu.addEventListener('click', function() {
            menu.classList.toggle('active');
            const icono = botonMenu.querySelector('i');
            icono.classList.toggle('fa-bars');
            icono.classList.toggle('fa-times');
            
            // Animar bot√≥n
            this.classList.toggle('active');
        });
        
        // Cerrar men√∫ al hacer clic en enlace
        const enlaces = document.querySelectorAll('.nav-link');
        enlaces.forEach(enlace => {
            enlace.addEventListener('click', function() {
                menu.classList.remove('active');
                botonMenu.querySelector('i').className = 'fas fa-bars';
                botonMenu.classList.remove('active');
                
                // Actualizar enlace activo
                enlaces.forEach(e => e.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
    
    // Navegaci√≥n suave
    document.querySelectorAll('a[href^="#"]').forEach(enlace => {
        enlace.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href === '#' || href === '#!') return;
            
            e.preventDefault();
            const objetivo = document.querySelector(href);
            if (objetivo) {
                const alturaNav = document.querySelector('.navbar').offsetHeight;
                const posicion = objetivo.offsetTop - alturaNav - 20;
                
                window.scrollTo({
                    top: posicion,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Efecto navbar al hacer scroll
    window.addEventListener('scroll', function() {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 100) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });
}

// ===========================================
// INICIALIZACI√ìN DE M√ìDULOS
// ===========================================
function inicializarModulos() {
    // Aqu√≠ se podr√≠a cargar din√°micamente los m√≥dulos si fuera necesario
    // Por ahora usamos el HTML est√°tico
    
    // Configurar eventos de m√≥dulos
    const modulos = document.querySelectorAll('.module');
    modulos.forEach(modulo => {
        const moduloId = modulo.getAttribute('data-module');
        if (moduloId) {
            // Configurar botones de navegaci√≥n entre m√≥dulos
            const navButtons = modulo.querySelectorAll('.nav-arrow');
            navButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetHref = this.getAttribute('href');
                    if (targetHref && targetHref.startsWith('#')) {
                        const target = document.querySelector(targetHref);
                        if (target) {
                            const alturaNav = document.querySelector('.navbar').offsetHeight;
                            const posicion = target.offsetTop - alturaNav - 20;
                            window.scrollTo({ top: posicion, behavior: 'smooth' });
                        }
                    }
                });
            });
            
            // Configurar checkbox de completado
            const checkbox = modulo.querySelector(`#complete-mod${moduloId}`);
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    toggleModuloCompletado(parseInt(moduloId), this.checked);
                });
                
                // Marcar si ya est√° completado
                if (APP_STATE.progreso.modulosCompletados.includes(parseInt(moduloId))) {
                    checkbox.checked = true;
                }
            }
        }
    });
}

function toggleModuloCompletado(moduloId, completado) {
    if (completado) {
        if (!APP_STATE.progreso.modulosCompletados.includes(moduloId)) {
            APP_STATE.progreso.modulosCompletados.push(moduloId);
            mostrarNotificacion(`‚úÖ M√≥dulo ${moduloId} marcado como completado`, 'success');
        }
    } else {
        const index = APP_STATE.progreso.modulosCompletados.indexOf(moduloId);
        if (index > -1) {
            APP_STATE.progreso.modulosCompletados.splice(index, 1);
        }
    }
    
    // Actualizar progreso general
    actualizarProgresoGeneral();
    guardarEstado();
}

// ===========================================
// FLASHCARDS - SISTEMA COMPLETO
// ===========================================
function inicializarFlashcards() {
    // Inicializar cada contenedor de flashcards
    const contenedores = document.querySelectorAll('.flashcards-container');
    
    contenedores.forEach(contenedor => {
        const moduloId = parseInt(contenedor.getAttribute('data-module'));
        
        if (FLASHCARDS_DATA[moduloId] && FLASHCARDS_DATA[moduloId].length > 0) {
            configurarFlashcardsModulo(contenedor, moduloId);
        } else {
            // Mostrar mensaje si no hay flashcards
            contenedor.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-info-circle fa-3x"></i>
                    <h4>No hay flashcards para este m√≥dulo</h4>
                    <p>Puedes agregar flashcards editando el archivo script.js</p>
                </div>
            `;
        }
    });
}

function configurarFlashcardsModulo(contenedor, moduloId) {
    const flashcards = FLASHCARDS_DATA[moduloId];
    let indiceActual = 0;
    
    // Obtener elementos
    const flashcardElement = contenedor.querySelector('.flashcard');
    const contador = contenedor.querySelector('.card-counter');
    const btnAnterior = contenedor.querySelector('#prev-card-mod' + moduloId);
    const btnSiguiente = contenedor.querySelector('#next-card-mod' + moduloId);
    const btnVoltear = contenedor.querySelector('#flip-card-mod' + moduloId);
    const btnMezclar = contenedor.querySelector('#shuffle-cards-mod' + moduloId);
    
    // Funci√≥n para actualizar la flashcard mostrada
    function actualizarFlashcard() {
        const flashcard = flashcards[indiceActual];
        
        if (flashcard && flashcardElement) {
            const frente = flashcardElement.querySelector('.flashcard-front .flashcard-question');
            const reverso = flashcardElement.querySelector('.flashcard-back .flashcard-answer');
            
            if (frente) frente.textContent = flashcard.pregunta;
            if (reverso) {
                // A√±adir informaci√≥n adicional si existe
                let respuestaHTML = flashcard.respuesta;
                if (flashcard.categoria || flashcard.dificultad) {
                    respuestaHTML += `<div class="flashcard-info"><small>Categor√≠a: ${flashcard.categoria || 'General'} | Dificultad: ${flashcard.dificultad || 'Media'}</small></div>`;
                }
                reverso.innerHTML = respuestaHTML;
            }
            
            // Asegurar que est√© en el frente
            flashcardElement.classList.remove('flipped');
            
            // Actualizar contador
            if (contador) {
                contador.textContent = `${indiceActual + 1}/${flashcards.length}`;
            }
            
            // Actualizar barra de progreso si existe
            const barraProgreso = contenedor.querySelector('.flashcards-progress .progress-fill');
            if (barraProgreso) {
                const porcentaje = ((indiceActual + 1) / flashcards.length) * 100;
                barraProgreso.style.width = `${porcentaje}%`;
            }
        }
    }
    
    // Funci√≥n para navegar entre flashcards
    function navegarFlashcard(direccion) {
        indiceActual += direccion;
        
        // Circular entre flashcards
        if (indiceActual < 0) {
            indiceActual = flashcards.length - 1;
        } else if (indiceActual >= flashcards.length) {
            indiceActual = 0;
        }
        
        actualizarFlashcard();
        registrarEstudioFlashcard(moduloId);
    }
    
    // Funci√≥n para mezclar flashcards
    function mezclarFlashcards() {
        // Algoritmo de Fisher-Yates para mezclar
        for (let i = flashcards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
        }
        
        indiceActual = 0;
        actualizarFlashcard();
        mostrarNotificacion('üé≤ Flashcards mezcladas', 'success');
    }
    
    // Configurar eventos
    if (btnAnterior) {
        btnAnterior.addEventListener('click', () => navegarFlashcard(-1));
    }
    
    if (btnSiguiente) {
        btnSiguiente.addEventListener('click', () => navegarFlashcard(1));
    }
    
    if (btnVoltear) {
        btnVoltear.addEventListener('click', () => {
            flashcardElement.classList.toggle('flipped');
        });
    }
    
    if (btnMezclar) {
        btnMezclar.addEventListener('click', mezclarFlashcards);
    }
    
    // Permitir voltear con clic en la tarjeta
    if (flashcardElement) {
        flashcardElement.addEventListener('click', function(e) {
            // No voltear si se hace clic en un bot√≥n
            if (!e.target.closest('.btn') && !e.target.closest('.flashcard-btn')) {
                this.classList.toggle('flipped');
            }
        });
    }
    
    // Navegaci√≥n con teclado
    document.addEventListener('keydown', function(e) {
        if (contenedor.closest('.module').getBoundingClientRect().top < window.innerHeight &&
            contenedor.closest('.module').getBoundingClientRect().bottom > 0) {
            
            if (e.key === 'ArrowLeft') {
                navegarFlashcard(-1);
            } else if (e.key === 'ArrowRight') {
                navegarFlashcard(1);
            } else if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                flashcardElement.classList.toggle('flipped');
            }
        }
    });
    
    // Inicializar con la primera flashcard
    actualizarFlashcard();
}

function registrarEstudioFlashcard(moduloId) {
    APP_STATE.progreso.flashcardsEstudiadas++;
    
    // Marcar m√≥dulo como estudiado si no est√° en la lista
    if (!APP_STATE.progreso.modulosCompletados.includes(moduloId)) {
        APP_STATE.progreso.modulosCompletados.push(moduloId);
    }
    
    actualizarContadores();
    guardarEstado();
}

// ===========================================
// QUIZZES - SISTEMA COMPLETO
// ===========================================
function inicializarQuizzes() {
    const contenedores = document.querySelectorAll('.quiz-container');
    
    contenedores.forEach(contenedor => {
        const moduloId = parseInt(contenedor.getAttribute('data-module'));
        
        if (QUIZZES_DATA[moduloId] && QUIZZES_DATA[moduloId].preguntas.length > 0) {
            configurarQuizModulo(contenedor, moduloId);
        } else {
            contenedor.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-info-circle fa-3x"></i>
                    <h4>No hay quiz para este m√≥dulo</h4>
                    <p>Puedes agregar preguntas editando el archivo script.js</p>
                </div>
            `;
        }
    });
}

function configurarQuizModulo(contenedor, moduloId) {
    const quiz = QUIZZES_DATA[moduloId];
    let preguntaActual = 0;
    let respuestasUsuario = [];
    let puntaje = 0;
    
    // Obtener elementos
    const preguntaTexto = contenedor.querySelector('#question-text-mod' + moduloId);
    const opciones = contenedor.querySelectorAll('.quiz-options .option');
    const btnVerificar = contenedor.querySelector('#submit-quiz-mod' + moduloId);
    const btnSiguiente = contenedor.querySelector('#next-quiz-mod' + moduloId);
    const feedback = contenedor.querySelector('#quiz-feedback-mod' + moduloId);
    const resultados = contenedor.querySelector('#quiz-results-mod' + moduloId);
    
    // Funci√≥n para cargar pregunta
    function cargarPregunta() {
        const pregunta = quiz.preguntas[preguntaActual];
        
        if (pregunta && preguntaTexto) {
            // Actualizar texto de la pregunta
            preguntaTexto.textContent = pregunta.pregunta;
            
            // Actualizar n√∫mero de pregunta si existe
            const numeroPregunta = contenedor.querySelector('#question-number-mod' + moduloId);
            if (numeroPregunta) {
                numeroPregunta.textContent = preguntaActual + 1;
            }
            
            // Actualizar barra de progreso
            const barraProgreso = contenedor.querySelector('.quiz-progress .progress-fill');
            if (barraProgreso) {
                const porcentaje = ((preguntaActual) / quiz.preguntas.length) * 100;
                barraProgreso.style.width = `${porcentaje}%`;
            }
            
            // Actualizar contador
            const contador = contenedor.querySelector('#current-question-mod' + moduloId);
            const total = contenedor.querySelector('#total-questions-mod' + moduloId);
            if (contador) contador.textContent = preguntaActual + 1;
            if (total) total.textContent = quiz.preguntas.length;
            
            // Limpiar opciones seleccionadas
            opciones.forEach(opcion => {
                const input = opcion.querySelector('input');
                const label = opcion.querySelector('label');
                
                if (input) input.checked = false;
                if (label) {
                    // Restaurar texto original si existe
                    const textoOriginal = label.getAttribute('data-original-text');
                    if (textoOriginal) {
                        label.innerHTML = textoOriginal;
                    }
                }
                
                // Limpiar clases de estado
                opcion.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Ocultar feedback y resultados
            if (feedback) feedback.style.display = 'none';
            if (resultados) resultados.style.display = 'none';
            
            // Mostrar bot√≥n verificar, ocultar siguiente
            if (btnVerificar) {
                btnVerificar.style.display = 'inline-flex';
                btnVerificar.disabled = true;
            }
            if (btnSiguiente) btnSiguiente.style.display = 'none';
        }
    }
    
    // Configurar eventos de opciones
    opciones.forEach((opcion, indice) => {
        const input = opcion.querySelector('input');
        const label = opcion.querySelector('label');
        
        // Guardar texto original
        if (label && !label.hasAttribute('data-original-text')) {
            label.setAttribute('data-original-text', label.innerHTML);
        }
        
        opcion.addEventListener('click', function(e) {
            // Solo seleccionar si no es una respuesta ya verificada
            if (!this.classList.contains('correct') && !this.classList.contains('incorrect')) {
                // Deseleccionar otras opciones
                opciones.forEach(o => {
                    o.classList.remove('selected');
                    const inp = o.querySelector('input');
                    if (inp) inp.checked = false;
                });
                
                // Seleccionar esta opci√≥n
                this.classList.add('selected');
                if (input) input.checked = true;
                
                // Habilitar bot√≥n de verificar
                if (btnVerificar) btnVerificar.disabled = false;
            }
        });
    });
    
    // Configurar bot√≥n verificar
    if (btnVerificar) {
        btnVerificar.addEventListener('click', function() {
            const opcionSeleccionada = contenedor.querySelector('.option.selected');
            
            if (!opcionSeleccionada) return;
            
            const pregunta = quiz.preguntas[preguntaActual];
            const indiceSeleccionado = Array.from(opciones).indexOf(opcionSeleccionada);
            const esCorrecta = indiceSeleccionado === pregunta.respuestaCorrecta;
            
            // Guardar respuesta del usuario
            respuestasUsuario[preguntaActual] = {
                seleccionada: indiceSeleccionado,
                correcta: pregunta.respuestaCorrecta,
                esCorrecta: esCorrecta
            };
            
            // Actualizar puntaje
            if (esCorrecta) {
                puntaje += pregunta.puntos || 10;
            }
            
            // Mostrar feedback
            if (feedback) {
                if (esCorrecta) {
                    feedback.innerHTML = `
                        <div class="feedback-correct">
                            <i class="fas fa-check-circle"></i>
                            <strong>¬°Correcto!</strong> ${pregunta.explicacion}
                        </div>
                    `;
                    feedback.className = 'quiz-feedback correct';
                } else {
                    const respuestaCorrecta = pregunta.opciones[pregunta.respuestaCorrecta];
                    feedback.innerHTML = `
                        <div class="feedback-incorrect">
                            <i class="fas fa-times-circle"></i>
                            <strong>Incorrecto.</strong> La respuesta correcta es: "${respuestaCorrecta}"
                            <br><small>${pregunta.explicacion}</small>
                        </div>
                    `;
                    feedback.className = 'quiz-feedback incorrect';
                }
                feedback.style.display = 'block';
            }
            
            // Resaltar opciones correctas e incorrectas
            opciones.forEach((opcion, indice) => {
                if (indice === pregunta.respuestaCorrecta) {
                    opcion.classList.add('correct');
                } else if (indice === indiceSeleccionado && !esCorrecta) {
                    opcion.classList.add('incorrect');
                }
            });
            
            // Cambiar botones
            this.style.display = 'none';
            if (btnSiguiente) {
                btnSiguiente.style.display = 'inline-flex';
                
                // Cambiar texto si es la √∫ltima pregunta
                if (preguntaActual === quiz.preguntas.length - 1) {
                    btnSiguiente.innerHTML = '<i class="fas fa-chart-bar"></i> Ver Resultados';
                }
            }
        });
    }
    
    // Configurar bot√≥n siguiente
    if (btnSiguiente) {
        btnSiguiente.addEventListener('click', function() {
            // Si es la √∫ltima pregunta, mostrar resultados
            if (preguntaActual === quiz.preguntas.length - 1) {
                mostrarResultadosQuiz();
                return;
            }
            
            // Ir a la siguiente pregunta
            preguntaActual++;
            cargarPregunta();
        });
    }
    
    // Funci√≥n para mostrar resultados finales
    function mostrarResultadosQuiz() {
        const porcentaje = Math.round((puntaje / (quiz.preguntas.length * 10)) * 100);
        
        let mensajeResultado = '';
        if (porcentaje >= 80) {
            mensajeResultado = '¬°Excelente! üéâ Dominas este tema.';
        } else if (porcentaje >= 60) {
            mensajeResultado = 'Buen trabajo üëç, pero puedes mejorar.';
        } else {
            mensajeResultado = 'Necesitas repasar m√°s este tema üìö.';
        }
        
        // Mostrar resultados
        if (resultados) {
            resultados.innerHTML = `
                <div class="quiz-results-content">
                    <h3><i class="fas fa-trophy"></i> Resultados del Quiz</h3>
                    <div class="puntaje-final">
                        <div class="puntaje-numero">${puntaje}/${quiz.preguntas.length * 10}</div>
                        <div class="puntaje-porcentaje">${porcentaje}%</div>
                    </div>
                    <p class="mensaje-resultado">${mensajeResultado}</p>
                    
                    <div class="detalle-respuestas">
                        <h4>Detalle de respuestas:</h4>
                        ${quiz.preguntas.map((pregunta, index) => {
                            const respuesta = respuestasUsuario[index];
                            const esCorrecta = respuesta ? respuesta.esCorrecta : false;
                            return `
                                <div class="detalle-pregunta ${esCorrecta ? 'correcta' : 'incorrecta'}">
                                    <div class="pregunta-texto">${index + 1}. ${pregunta.pregunta}</div>
                                    <div class="respuesta-usuario">Tu respuesta: ${pregunta.opciones[respuesta?.seleccionada || 0]}</div>
                                    ${!esCorrecta ? `<div class="respuesta-correcta">Correcta: ${pregunta.opciones[pregunta.respuestaCorrecta]}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="acciones-resultados">
                        <button class="btn btn-primary" id="reiniciar-quiz">
                            <i class="fas fa-redo"></i> Repetir Quiz
                        </button>
                        <button class="btn btn-secondary" id="ver-flashcards">
                            <i class="fas fa-cards"></i> Repasar Flashcards
                        </button>
                    </div>
                </div>
            `;
            
            resultados.style.display = 'block';
            
            // Configurar botones de resultados
            document.getElementById('reiniciar-quiz').addEventListener('click', function() {
                reiniciarQuiz();
            });
            
            document.getElementById('ver-flashcards').addEventListener('click', function() {
                // Desplazarse a las flashcards
                const seccionModulo = document.querySelector(`#modulo${moduloId}`);
                if (seccionModulo) {
                    seccionModulo.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            // Ocultar otros elementos
            contenedor.querySelector('.quiz-question').style.display = 'none';
            contenedor.querySelector('.quiz-options').style.display = 'none';
            contenedor.querySelector('.quiz-actions').style.display = 'none';
            if (feedback) feedback.style.display = 'none';
        }
        
        // Registrar en el progreso
        if (!APP_STATE.progreso.quizzesCompletados.includes(moduloId)) {
            APP_STATE.progreso.quizzesCompletados.push(moduloId);
        }
        
        // Marcar m√≥dulo como completado
        if (!APP_STATE.progreso.modulosCompletados.includes(moduloId)) {
            APP_STATE.progreso.modulosCompletados.push(moduloId);
        }
        
        actualizarContadores();
        guardarEstado();
    }
    
    // Funci√≥n para reiniciar el quiz
    function reiniciarQuiz() {
        preguntaActual = 0;
        respuestasUsuario = [];
        puntaje = 0;
        
        // Mostrar elementos del quiz
        contenedor.querySelector('.quiz-question').style.display = 'block';
        contenedor.querySelector('.quiz-options').style.display = 'block';
        contenedor.querySelector('.quiz-actions').style.display = 'flex';
        
        // Ocultar resultados
        if (resultados) resultados.style.display = 'none';
        
        // Cargar primera pregunta
        cargarPregunta();
    }
    
    // Inicializar con la primera pregunta
    cargarPregunta();
}

// ===========================================
// RECURSOS Y APUNTES
// ===========================================
function inicializarRecursos() {
    // Configurar eventos para la subida de im√°genes (simulada)
    const botonesSubida = document.querySelectorAll('.upload-trigger');
    botonesSubida.forEach(boton => {
        boton.addEventListener('click', mostrarGuiaSubida);
    });
    
    // Configurar eventos para visualizaci√≥n de im√°genes
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('note-image') || e.target.closest('.note-image')) {
            const img = e.target.classList.contains('note-image') ? e.target : e.target.closest('.note-image');
            abrirVisorImagen(img.src, img.alt);
        }
    });
    
    // Configurar botones de descarga de plantillas
    const btnPlantillaFlashcards = document.querySelector('[onclick*="downloadFlashcardTemplate"]');
    const btnPlantillaQuiz = document.querySelector('[onclick*="downloadQuizTemplate"]');
    
    if (btnPlantillaFlashcards) {
        btnPlantillaFlashcards.addEventListener('click', descargarPlantillaFlashcards);
    }
    
    if (btnPlantillaQuiz) {
        btnPlantillaQuiz.addEventListener('click', descargarPlantillaQuiz);
    }
}

function mostrarGuiaSubida() {
    mostrarNotificacion(
        'üìÅ Para subir im√°genes en GitHub Pages: ' +
        '1. Sube tus im√°genes a la carpeta "images/" en tu repositorio<br>' +
        '2. En el HTML, usa: &lt;img src="images/tu-imagen.jpg"&gt;',
        'info',
        5000
    );
}

function descargarPlantillaFlashcards() {
    const plantilla = {
        instrucciones: "Agrega este objeto al array FLASHCARDS_DATA en script.js",
        ejemplo: {
            modulo: 1,
            flashcard: {
                id: 1,
                pregunta: "Tu pregunta aqu√≠",
                respuesta: "Tu respuesta aqu√≠",
                categoria: "Categor√≠a (opcional)",
                dificultad: "b√°sica/intermedia/avanzada (opcional)"
            }
        }
    };
    
    descargarJSON(plantilla, 'plantilla-flashcards.json');
    mostrarNotificacion('üì• Plantilla de flashcards descargada', 'success');
}

function descargarPlantillaQuiz() {
    const plantilla = {
        instrucciones: "Agrega este objeto al array QUIZZES_DATA en script.js",
        ejemplo: {
            modulo: 1,
            quiz: {
                titulo: "T√≠tulo del quiz",
                preguntas: [
                    {
                        id: 1,
                        pregunta: "Tu pregunta aqu√≠",
                        opciones: ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C", "Opci√≥n D"],
                        respuestaCorrecta: 0,
                        explicacion: "Explicaci√≥n de la respuesta",
                        puntos: 10
                    }
                ]
            }
        }
    };
    
    descargarJSON(plantilla, 'plantilla-quiz.json');
    mostrarNotificacion('üì• Plantilla de quiz descargada', 'success');
}

function abrirVisorImagen(src, alt) {
    // Crear modal simple
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        cursor: pointer;
    `;
    
    modal.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 90%;">
            <img src="${src}" alt="${alt}" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
            <div style="position: absolute; bottom: -40px; left: 0; color: white; text-align: center; width: 100%;">
                ${alt || 'Imagen de apuntes'}
            </div>
            <button style="position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Cerrar modal al hacer clic
    modal.addEventListener('click', function(e) {
        if (e.target === modal || e.target.closest('button')) {
            document.body.removeChild(modal);
        }
    });
    
    // Cerrar con ESC
    document.addEventListener('keydown', function cerrarConESC(e) {
        if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.removeEventListener('keydown', cerrarConESC);
        }
    });
}

// ===========================================
// SISTEMA DE PROGRESO
// ===========================================
function inicializarProgreso() {
    // Actualizar todos los contadores
    actualizarContadores();
    actualizarProgresoGeneral();
    
    // Configurar eventos de servicio social
    const btnAgregarHoras = document.querySelector('[onclick*="addServiceHours"]');
    const btnReiniciarHoras = document.querySelector('[onclick*="resetServiceHours"]');
    
    if (btnAgregarHoras) {
        btnAgregarHoras.addEventListener('click', function() {
            agregarHorasServicio(40);
        });
    }
    
    if (btnReiniciarHoras) {
        btnReiniciarHoras.addEventListener('click', reiniciarHorasServicio);
    }
    
    // Configurar exportaci√≥n/importaci√≥n
    const btnExportar = document.querySelector('[onclick*="exportarProgreso"]');
    const inputImportar = document.getElementById('import-progress-file');
    
    if (btnExportar) {
        btnExportar.addEventListener('click', exportarProgreso);
    }
    
    if (inputImportar) {
        inputImportar.addEventListener('change', importarProgreso);
    }
}

function actualizarContadores() {
    // Actualizar contadores en el hero
    const contadorModulos = document.getElementById('contador-modulos');
    const contadorFlashcards = document.getElementById('contador-flashcards');
    const contadorQuizzes = document.getElementById('contador-quizzes');
    const contadorHoras = document.getElementById('service-hours');
    
    if (contadorModulos) {
        contadorModulos.textContent = APP_STATE.progreso.modulosCompletados.length;
    }
    
    if (contadorFlashcards) {
        contadorFlashcards.textContent = APP_STATE.progreso.flashcardsEstudiadas;
    }
    
    if (contadorQuizzes) {
        contadorQuizzes.textContent = APP_STATE.progreso.quizzesCompletados.length;
    }
    
    if (contadorHoras) {
        contadorHoras.textContent = APP_STATE.progreso.horasServicio;
        
        // Actualizar barra de progreso de horas
        const barraHoras = document.querySelector('#servicio-social .progress-fill');
        if (barraHoras) {
            const porcentaje = (APP_STATE.progreso.horasServicio / 320) * 100;
            barraHoras.style.width = `${Math.min(porcentaje, 100)}%`;
        }
    }
}

function actualizarProgresoGeneral() {
    const barraProgreso = document.getElementById('progreso-general');
    if (barraProgreso) {
        const porcentaje = (APP_STATE.progreso.modulosCompletados.length / 7) * 100;
        barraProgreso.style.width = `${porcentaje}%`;
        barraProgreso.setAttribute('data-progress', `${Math.round(porcentaje)}%`);
    }
    
    // Actualizar tabla de progreso si existe
    const tbody = document.getElementById('progress-table-body');
    if (tbody) {
        tbody.innerHTML = PLAN_ESTUDIOS.modulos.map(modulo => {
            const completado = APP_STATE.progreso.modulosCompletados.includes(modulo.id);
            const quizCompletado = APP_STATE.progreso.quizzesCompletados.includes(modulo.id);
            
            return `
                <tr>
                    <td><strong>M√≥dulo ${modulo.id}</strong><br><small>${modulo.titulo.substring(0, 50)}...</small></td>
                    <td>${modulo.temas.length}</td>
                    <td>${FLASHCARDS_DATA[modulo.id] ? FLASHCARDS_DATA[modulo.id].length : 0}</td>
                    <td>${QUIZZES_DATA[modulo.id] ? QUIZZES_DATA[modulo.id].preguntas.length : 0}</td>
                    <td>
                        <span class="estado ${completado ? 'completado' : 'pendiente'}">
                            <i class="fas fa-${completado ? 'check-circle' : 'clock'}"></i>
                            ${completado ? 'Completado' : 'En progreso'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="irAModulo(${modulo.id})">
                            <i class="fas fa-book-open"></i> Estudiar
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
}

function agregarHorasServicio(horas) {
    APP_STATE.progreso.horasServicio = Math.min(APP_STATE.progreso.horasServicio + horas, 320);
    actualizarContadores();
    guardarEstado();
    mostrarNotificacion(`‚ûï ${horas} horas agregadas al servicio social`, 'success');
}

function reiniciarHorasServicio() {
    APP_STATE.progreso.horasServicio = 0;
    actualizarContadores();
    guardarEstado();
    mostrarNotificacion('üîÑ Horas de servicio reiniciadas', 'info');
}

function exportarProgreso() {
    const datos = {
        aplicacion: CONFIG.appName,
        version: CONFIG.version,
        fechaExportacion: new Date().toISOString(),
        progreso: APP_STATE.progreso
    };
    
    descargarJSON(datos, `progreso-rescate-${new Date().toISOString().slice(0, 10)}.json`);
    mostrarNotificacion('üì§ Progreso exportado correctamente', 'success');
}

function importarProgreso(event) {
    const archivo = event.target.files[0];
    if (!archivo) return;
    
    const lector = new FileReader();
    lector.onload = function(e) {
        try {
            const datos = JSON.parse(e.target.result);
            
            // Validar que sea un archivo de progreso v√°lido
            if (datos.progreso && datos.aplicacion === CONFIG.appName) {
                APP_STATE.progreso = datos.progreso;
                guardarEstado();
                actualizarContadores();
                actualizarProgresoGeneral();
                mostrarNotificacion('üì• Progreso importado correctamente', 'success');
            } else {
                mostrarNotificacion('‚ùå Archivo de progreso inv√°lido', 'error');
            }
        } catch (error) {
            mostrarNotificacion(`‚ùå Error al importar: ${error.message}`, 'error');
        }
    };
    
    lector.readAsText(archivo);
    event.target.value = ''; // Resetear input
}

// ===========================================
// ALMACENAMIENTO LOCAL
// ===========================================
function cargarEstado() {
    try {
        const datosGuardados = localStorage.getItem(CONFIG.storageKey);
        if (datosGuardados) {
            const parsed = JSON.parse(datosGuardados);
            
            // Fusionar progreso guardado con el estado actual
            if (parsed.progreso) {
                APP_STATE.progreso = { ...APP_STATE.progreso, ...parsed.progreso };
            }
            
            console.log('üìÇ Estado cargado del localStorage');
        }
    } catch (error) {
        console.error('Error al cargar estado:', error);
        // En caso de error, mantener estado por defecto
    }
}

function guardarEstado() {
    try {
        const datosAGuardar = {
            progreso: APP_STATE.progreso,
            ultimaActualizacion: new Date().toISOString()
        };
        
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(datosAGuardar));
        console.log('üíæ Estado guardado en localStorage');
    } catch (error) {
        console.error('Error al guardar estado:', error);
    }
}

// ===========================================
// EVENTOS GLOBALES Y UTILIDADES
// ===========================================
function inicializarEventosGlobales() {
    // Botones de impresi√≥n
    const botonesImprimir = document.querySelectorAll('.print-trigger');
    botonesImprimir.forEach(boton => {
        boton.addEventListener('click', function() {
            window.print();
        });
    });
    
    // Bot√≥n para ir arriba
    const btnIrArriba = document.createElement('button');
    btnIrArriba.innerHTML = '<i class="fas fa-arrow-up"></i>';
    btnIrArriba.className = 'btn-ir-arriba';
    btnIrArriba.title = 'Ir arriba';
    btnIrArriba.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all var(--transition-base);
    `;
    
    document.body.appendChild(btnIrArriba);
    
    btnIrArriba.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Mostrar/ocultar bot√≥n al hacer scroll
    window.addEventListener('scroll', function() {
        if (window.scrollY > 500) {
            btnIrArriba.style.display = 'flex';
        } else {
            btnIrArriba.style.display = 'none';
        }
    });
    
    // Evento para detectar cambios de m√≥dulo en el scroll
    window.addEventListener('scroll', detectarModuloVisible);
}

function detectarModuloVisible() {
    const modulos = document.querySelectorAll('.module');
    let moduloVisible = null;
    
    modulos.forEach(modulo => {
        const rect = modulo.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 100) {
            moduloVisible = modulo;
        }
    });
    
    if (moduloVisible) {
        // Actualizar enlace activo en la navegaci√≥n
        const moduloId = moduloVisible.id;
        const enlaces = document.querySelectorAll('.nav-link');
        enlaces.forEach(enlace => {
            enlace.classList.remove('active');
            if (enlace.getAttribute('href') === `#${moduloId}`) {
                enlace.classList.add('active');
            }
        });
    }
}

// ===========================================
// FUNCIONES DE UTILIDAD
// ===========================================
function mostrarNotificacion(mensaje, tipo = 'info', duracion = 3000) {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `notificacion notificacion-${tipo}`;
    
    const iconos = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    notificacion.innerHTML = `
        <div class="notificacion-contenido">
            <i class="fas ${iconos[tipo] || iconos.info}"></i>
            <span>${mensaje}</span>
        </div>
        <button class="notificacion-cerrar">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Estilos
    notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        max-width: 400px;
        backdrop-filter: blur(10px);
    `;
    
    // Colores seg√∫n tipo
    const colores = {
        success: 'linear-gradient(135deg, #4CAF50, #2E7D32)',
        error: 'linear-gradient(135deg, #f44336, #c62828)',
        warning: 'linear-gradient(135deg, #ff9800, #ef6c00)',
        info: 'linear-gradient(135deg, #2196F3, #1565C0)'
    };
    
    notificacion.style.background = colores[tipo] || colores.info;
    
    // Bot√≥n cerrar
    const btnCerrar = notificacion.querySelector('.notificacion-cerrar');
    btnCerrar.addEventListener('click', function() {
        notificacion.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 250);
    });
    
    // A√±adir al documento
    document.body.appendChild(notificacion);
    
    // Auto-eliminar despu√©s de la duraci√≥n
    if (duracion > 0) {
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 250);
            }
        }, duracion);
    }
    
    // A√±adir estilos de animaci√≥n si no existen
    if (!document.getElementById('notificacion-estilos')) {
        const estilos = document.createElement('style');
        estilos.id = 'notificacion-estilos';
        estilos.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .notificacion-cerrar {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                margin-left: 15px;
                opacity: 0.8;
                transition: opacity 0.2s;
            }
            .notificacion-cerrar:hover {
                opacity: 1;
            }
        `;
        document.head.appendChild(estilos);
    }
}

function descargarJSON(datos, nombreArchivo) {
    const jsonStr = JSON.stringify(datos, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function irAModulo(moduloId) {
    const modulo = document.querySelector(`#modulo${moduloId}`);
    if (modulo) {
        const alturaNav = document.querySelector('.navbar').offsetHeight;
        const posicion = modulo.offsetTop - alturaNav - 20;
        window.scrollTo({ top: posicion, behavior: 'smooth' });
    }
}

// ===========================================
// FUNCIONES GLOBALES PARA HTML
// ===========================================
// Hacer funciones disponibles para onclick en HTML
window.downloadFlashcardTemplate = descargarPlantillaFlashcards;
window.downloadQuizTemplate = descargarPlantillaQuiz;
window.exportarProgreso = exportarProgreso;
window.addServiceHours = agregarHorasServicio;
window.resetServiceHours = reiniciarHorasServicio;
window.irAModulo = irAModulo;

// Funci√≥n para toggle de m√≥dulo completado (usada en HTML)
window.toggleModuleComplete = function(moduloId) {
    const checkbox = document.getElementById(`complete-mod${moduloId}`);
    if (checkbox) {
        toggleModuloCompletado(moduloId, checkbox.checked);
    }
};

// ===========================================
// INICIALIZACI√ìN FINAL
// ===========================================
// Asegurar que todo est√© listo
window.addEventListener('load', function() {
    // Verificar si estamos en GitHub Pages
    const isGitHubPages = window.location.hostname.includes('github.io');
    
    if (isGitHubPages) {
        // Mostrar mensaje de bienvenida para GitHub Pages
        setTimeout(() => {
            mostrarNotificacion(
                'üöë R.E.S.C.A.T.E. Paramedico - GitHub Pages<br>' +
                'Tu progreso se guarda autom√°ticamente en tu navegador',
                'info',
                5000
            );
        }, 1000);
    }
    
    // A√±adir estilos adicionales si es necesario
    const estilosAdicionales = document.createElement('style');
    estilosAdicionales.textContent = `
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }
        .empty-state i {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        .estado.completado {
            color: var(--success-color);
            font-weight: 600;
        }
        .estado.pendiente {
            color: var(--warning-color);
        }
        .image-modal img {
            cursor: default;
        }
    `;
    document.head.appendChild(estilosAdicionales);
    
    console.log('‚úÖ Aplicaci√≥n completamente cargada y lista');
});

// ===========================================
// EXPORTAR PARA USO GLOBAL (si es necesario)
// ===========================================
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        CONFIG,
        PLAN_ESTUDIOS,
        FLASHCARDS_DATA,
        QUIZZES_DATA,
        APP_STATE
    };
}
